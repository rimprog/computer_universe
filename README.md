# Парсер сайта [computeruniverse](https://www.computeruniverse.net/)

Проект реализует требования заказчика с фриланса на создание парсера сайта [computeruniverse](https://www.computeruniverse.net/) с последующем выводом данных в telegram и созданием административной панели для администрирования пользователей. С полным ТЗ можно ознакомиться [ЗДЕСЬ](https://freelance.habr.com/tasks/415425).

## Как это работает

* `Парсер` на основе [selenium](https://www.selenium.dev/selenium/docs/api/py/) по заданому временому интервалу собирает данные с сайта computeruniverse из раздела [графические карты](https://www.computeruniverse.net/en/c/hardware-components/pci-express-graphics-cards) и складирует полученную информацию о видеокартах во внутреннюю базу данных.
* Управляемая при помощи [Django ORM](https://docs.djangoproject.com/en/4.0/topics/db/models/) `База данных` хранит собранные при парсинге данные. Работа с содержимым внутренней базы данных, включая создание выборок и фильтрацию результатов ведется методами `django orm`.
* `Телеграм бот` представляет собой пользовательский интерфейс, позволяет пользователю зарегистрироваться и по доступным методам взаимодействовать с внутренней базой данных, настраивая выдачу результатов парсинга в удобном для себя формате.
* Внутренняя `Админка` на основе [административной панели django](https://docs.djangoproject.com/en/4.0/ref/contrib/admin/) позволяет администрировать зарегистрированных через телеграм бота пользователей и при необходимости корректировать полученные в ходе парсинга данные о видеокартах.
* [Custom django-admin commands](https://docs.djangoproject.com/en/4.0/howto/custom-management-commands/) по заданому временому интервалу  при помощи библиотеки [schedule](https://schedule.readthedocs.io/en/stable/) проверяет наличие обновления цен на видеокарты и в случае обнаружения присылает уведомление в телеграм пользователям по их заданым настройкам фильтров.

## Настройка проекта
Часть настроек проекта берётся из переменных окружения. Чтобы их определить, создайте файл `.env` рядом с `manage.py` и запишите туда данные в таком формате: `ПЕРЕМЕННАЯ=значение`.

Для старта работы telegram бота заполните следующие переменные:
`TELEGRAM_BOT_TOKEN` - получите токен у `@BotFather` и установите его значение в текущее поле. Подробнее [здесь](https://core.telegram.org/bots).

## Создание базы данных и запуск Django админки

- Для запуска сайта вам понадобится Python третьей версии.
- Скачайте репозиторий с кодом и прилегающими файлами.
- Установите зависимости командой `pip install -r requirements.txt`.
- Создайте базу данных SQLite командой `python3 manage.py migrate`.
- Создайте учетку администратора для админки Django командой `python3 manage.py createsuperuser`
- Запустите сервер разработчика командой `python3 manage.py runserver`.
- В браузере перейдите в админку по [адресу](http://127.0.0.1:8000/admin).

В случае успешного запуска, в консоль будет выведен ряд следующих уведомлений:
```
System check identified no issues (0 silenced).
September 29, 2021 - 12:00:38
Django version 3.2.7, using settings 'where_to_go.settings'
Starting development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.

```

## Запуск парсера computeruniverse

Для осуществления парсинга используется библиотека [python версия библиотеки selenium](https://www.selenium.dev/selenium/docs/api/py/). Для полноценной работы selenium вам потребуется [driver для вашего браузера](https://www.selenium.dev/selenium/docs/api/py/#drivers). Текущая версия проекта тестировалась на операционной системе Linux с браузером [Chromium](https://www.chromium.org/getting-involved/download-chromium/) и [ChromeDriver версии 85.0.4183.83](https://chromedriver.storage.googleapis.com/index.html?path=85.0.4183.83/). Скачайте подходящий под требования вашей операционной системы и браузера driver и поместите его в корневую папку проекта рядом с `manage.py`.


В окне нового терминала запустите парсер командой `python3 manage.py parse_graphic_cards`. При успешном запуске автоматически откроется окно браузера и начнется прокрутка страниц и переход по ним. В консоли будет выводиться текущее состояние процесса парсинга. Скрипт будет работать до его ручной остановки, непрерывно собирая нужную информацию. Ниже приблизительный вывод в консоли в случае успешного парсинга сайта:
```
100%|█████████████████████████████████████████████| 2/2 [01:08<00:00, 34.38s/it]

Successfully parsed graphic cards from computeruniverse graphic cards catalogue:
Gigabyte Radeon RX 6500 XT Gaming OC 4GB || Existing graphic card price was update successfully
New graphic cards are not found

100%|█████████████████████████████████████████████| 2/2 [01:08<00:00, 34.37s/it]

Successfully parsed graphic cards from computeruniverse graphic cards catalogue:
New graphic cards are not found
```
Команда запуска имеет один именованный аргумент, меняющий интервал перезапуска скрипта. Запустите парсер командой `python3 manage.py parse_graphic_cards --seconds 120` если хотите задать интервал в 120 секунд между повторениями задачи парсинга.

## Запуск телеграм бота и регистрация пользователя

- В окне нового терминала запустите телеграм бота командой `python3 manage.py telegram_bot`
- Перейдите в вашего бота и введите команду `/start`. Вам будет выведено следующее сообщение:
```
Ваша учетная запись успешно зарегистрирована.
Обратитесь к администратору ресурса для активации вашей учетной записи.
```
- Зайдите в [административный раздел сайта](http://127.0.0.1:8000/admin/storage/telegramuser/), выберите нового зарегистрированного пользователя и активируйте его учетную запись, поставив галочку в чекбоксе `Учетная запись активирована` и нажав кнопку сохранить.
- Перейдите обратно в телеграм бота и снова введите команду `/start`. Вам будет выведено следующее сообщение:
```
Ваша учетная запись успешно активирована.
Нажмите кнопку "Главное меню" для начала работы с ботом.
```
- Для дальнейшего взаимодействия с интерфейсом бота следуйте инструкциям.

## Запуск службы проверки обновления данных и последующего уведомления телеграм пользователей

В окне нового терминала запустите службу командой `python3 manage.py price_change_notifier`. Служба с заданой периодичностью начнет проверку обновления цен на видеокарты в базе данных. В консоль будет выводиться следующая информация:
```
New updated cards was found. Telegram users was notified successfully.
New updated cards was not found.
New updated cards was not found.
New updated cards was not found.
```
Команда запуска службы имеет один именованный аргумент, меняющий интервал перезапуска скрипта. Запустите службу командой `python3 manage.py price_change_notifier --seconds 120` если хотите задать интервал в 120 секунд между повторениями задачи проверки обновлений и последующего уведомления пользователей.

## Цели проекта

Код написан в рамках командного проекта учебной программы от [новичка до Middle](https://dvmn.org/t/middle-python-dev-before-you-finish-the-course/) на онлайн курсах обучению программирования python [Devman](https://dvmn.org/).
